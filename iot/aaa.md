# 分娩操作台通信协议及联调、上线说明

> 编写人：查文文
> 初版时间：2021年9月14日
> 版本：1.0
> 更新说明：针对GGP业务增加上报字段
> 编写目的：为了让相关人员明确通信协议、联调环境和上线流程等信息。

## 一、分娩操作台与IOT平台通信协议

分娩操作台不通过硬件网关接入，而是直接联网，通过MQTT和IOT平台保持通信。

MQTT服务器信息如下：
| 环境     | IP或域名        | 端口 | 用户名 | 密码        |
| -------- | --------------- | ---- | ------ | ----------- |
| 测试环境 | 119.3.69.124    | 1883 | admin  | ZAQ!xsw2123 |
| 生产环境 | iot.zberpnc.com | 1883 | admin  | ZAQ!xsw2123 |
| 局域网   | localhost       | 1883 | admin  | ZAQ!xsw2123 |

***开发测试阶段请配置成测试环境，出厂发货之前请配置成生产环境！***

分娩操作台需要和IOT平台交互的接口包括：

1. 设备登入：设备端发送PING信号，IOT平台接收消费成功后自动注册设备。
2. 电子耳标校验：目前GGP和PS略有不同。
   1. GGP业务的模式：由设备端实现耳标校验逻辑。IOT平台定时将所属猪场下的电子耳标数据推送到指定的MQTT主题，由设备端订阅消费。
   2. PS业务的模式：由IOT平台实现耳标校验逻辑。设备端发送一个耳标校验请求事件到指定的MQTT主题，IOT平台消费后，回复校验结果到指定的MQTT主题，设备端订阅消费后，根据校验结果决定是否继续进行下一步操作。
3. 分娩数据上报：设备端将称重数据发送到指定的MQTT主题，IOT平台消费并存储。

## 二、接口详细说明

下面详细说明每个接口的MQTT详细。

### 1 设备登入接口

设备端发送ping信号，IOT消费成功后自动注册设备。

发布主题：dev/client/ping/设备序列号。例如，设备序列号为100，则发布主题为：**dev/client/ping/100**

**简单起见，下文描述中的100，都是指设备序列号。**

消息内容：

```json
{
    "mfrs": "HMI",//消息来源，固定值
    "event": "ping",//消息类型，ping
    "timestamp": 1631152760,//发送时间
    "messageId": 1 //消息唯一id
}
```

### 2 耳标校验接口（PS业务的模式）

设备端发送耳标校验请求：

发布主题：**dev/client/event/100**

消息内容：

```json
{
  "event": "eid_status",//消息类型，eid_status
  "mfrs": "HMI",
  "messageId": 2,
  "timestamp": 1631152760,
  "data":{
      "eid":"hu0081"//电子耳标号
  }
}
```

IOT平台校验后，向另一个主题发布校验结果：

发布主题：**dev/server/event/eid_status/reply/100**

消息内容：

```json
{
  "timestamp": 1631152760,
  "messageId": 1,
  "success": false,//校验结果
  "code": "hu0081",//电子耳标号
  "message": "无效的耳标"//提示信息
}
```

### 3 耳标校验接口（GGP业务的模式）

IOT平台每天定时将设备绑定的猪场下的所有电子耳标数据发布到指定的MQTT主题：

发布主题：**dev/server/event/eid_data/100**

消息内容：

```json
{
  "timestamp": 1631152760,
  "messageId": 1,
  "event": "eid_data",
  "mfrs": "HMI",
  "data": [
    {
      "id": 1,//id
      "t_FNUMBER": "6315",//耳牌号
      "FElecEarNum": "xxx",//电子耳牌号
      "FNAME_L2": "长白",//品种
      "FDAYS": "1682",//日龄
      "CFLASTDATE": "2021-08-20 20:44:16.140000",//最新业务日期
      "CFLaststate": "配种记录",//最新业务
      "t4_FNAME_L2": "一分场配怀舍5栋",//存栏位置
      "CFBASESTATUS": "4",//状态
      "CFCURPT": "9",//当前胎位
      "CFMaterialName": "生产母猪",//猪只类型
      "FBizDate": "2021-08-20 20:44:16.140000",//配种时间
      "t6_FNUMBER": "DD00001011",//与配公猪
      "CFChildBirthDate": "2021-12-12 20:44:16.140000",//预产期
      "t7_FNAME_L2": "柏树猪场总场",//分场
      "t8_FNAME_L2": "柏树猪场",//猪场
      "create_time": "2021-08-20 20:44:16.140000"//数据从金蝶同步到IOT平台的时间
    }
    ...
  ]
}
```

**说明：上述data字段是个数组，只展示了一条示例数据而已。**

### 4 分娩数据上报接口

设备端每完成一只小猪称重，会将数据发布到指定的MQTT主题：

发布主题：**dev/client/event/100**

消息内容：

```json
{
  "mfrs": "HMI",
  "event": "status",//消息类型：status
  "timestamp": 1610527335,
  "messageId": 1,
  "data": [
    {
      "id": "10001",
      "state": "1",
      "renew": "1",
      "value": "admin"//操作用户名
    },
    {
      "id": "10002",
      "state": "1",
      "renew": "1",
      "value": "hu008"//母猪电子耳标值
    },
    {
      "id": "10003",
      "state": "1",
      "renew": "1",
      "value": "1"//单猪仔重量/出生窝重
    },
    {
      "id": "10004",
      "state": "1",
      "renew": "1",
      "value": "3"//总重量
    },
    {
      "id": "10005",
      "state": "1",
      "renew": "1",
      "value": "3"//活仔数
    },
    {
      "id": "10006",
      "state": "1",
      "renew": "1",
      "value": "3"//总仔数
    },
    {
      "id": "10007",
      "state": "1",
      "renew": "1",
      "value": "2"//合格公仔数
    },
    {
      "id": "10008",
      "state": "1",
      "renew": "1",
      "value": "1"//合格母仔数
    },
    {
      "id": "10009",
      "state": "1",
      "renew": "1",
      "value": "0"//弱仔数
    },
    {
      "id": "10010",
      "state": "1",
      "renew": "1",
      "value": "0"//畸形数
    },
    {
      "id": "10011",
      "state": "1",
      "renew": "1",
      "value": "0"//木乃伊数
    },
    {
      "id": "10012",
      "state": "1",
      "renew": "1",
      "value": "0"//死仔数
    },
    {
      "id": "10013",
      "state": "1",
      "renew": "1",
      "value": "猪场"//猪场
    },
    {
      "id": "10014",
      "state": "1",
      "renew": "1",
      "value": "分场"//分场
    },
    {
      "id": "10015",
      "state": "1",
      "renew": "1",
      "value": "存栏位置"//存栏位置
    },
    {
      "id": "10016",
      "state": "1",
      "renew": "1",
      "value": "公猪耳号"//公猪耳号
    },
    {
      "id": "10017",
      "state": "1",
      "renew": "1",
      "value": "胎次"//胎次
    },
    {
      "id": "10018",
      "state": "1",
      "renew": "1",
      "value": "妊娠天数"//妊娠天数
    },
    {
      "id": "10019",
      "state": "1",
      "renew": "1",
      "value": "分娩日期"//分娩日期
    },
     {
      "id": "10020",
      "state": "1",
      "renew": "1",
      "value": "产程"//产程
    },
     {
      "id": "10021",
      "state": "1",
      "renew": "1",
      "value": "分娩状态"//分娩状态
    },
     {
      "id": "10022",
      "state": "1",
      "renew": "1",
      "value": "合格仔猪"//合格仔猪
    },
     {
      "id": "10023",
      "state": "1",
      "renew": "1",
      "value": "种公"//种公
    },
     {
      "id": "10024",
      "state": "1",
      "renew": "1",
      "value": "种母"//种母
    },
     {
      "id": "10025",
      "state": "1",
      "renew": "1",
      "value": "备注"//备注
    },
  ]
}
```

三、发货及上线流程

由项目经理决定是否发货，并维护发货记录表。之前的Excel表格缺少设备序列号，请加上设备序列号一列，并把已发货的设备序列号补充完整。

![企业微信截图_20210914155519](/assets/企业微信截图_20210914155519.png)

一定要维护设备序列号！！！不然IOT平台无法将设备和收货组织绑定。

IOT平台收到PING信号后，自动注册设备，然后根据发货记录表，将设备和收货组织进行绑定，才算设备上线成功。
